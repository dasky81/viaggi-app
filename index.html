<!DOCTYPE html>
<html lang="it" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Viaggi.App ‚Ä¢ Il tuo Assistente di Viaggio</title>
  <meta name="description" content="Trova le migliori offerte di viaggio Logitravel e pianifica il tuo prossimo viaggio.">

  <!-- FONTS & ICONS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], display: ['"Outfit"', 'sans-serif'] },
          colors: {
            primary: '#0f172a',
            accent: '#3b82f6',
            brand: { trekk: '#4285f4', viaggi: '#ea4335', crociere: '#fbbc05', ai: '#8b5cf6', sponsor: '#10b981' }
          },
          animation: {
            'fade-up': 'fadeUp 0.6s ease-out forwards',
            'shimmer': 'shimmer 2s linear infinite',
            'bounce-soft': 'bounceSoft 2s infinite',
          },
          keyframes: {
            fadeUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            shimmer: { '0%': { backgroundPosition: '-1000px 0' }, '100%': { backgroundPosition: '1000px 0' } },
            bounceSoft: { '0%, 100%': { transform: 'translateY(-5%)' }, '50%': { transform: 'translateY(0)' } }
          }
        }
      }
    }
  </script>

  <style>
    /* Glassmorphism & Utilities */
    .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); }
    .glass-dark { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .skeleton { background: #f6f7f8; background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-repeat: no-repeat; background-size: 1000px 100%; animation: shimmer 1.5s infinite linear forwards; }
    
    /* Quiz Specifics */
    .option-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .option-btn:active { transform: scale(0.98); }
    .option-correct { background-color: #dcfce7 !important; border-color: #22c55e !important; color: #15803d !important; }
    .option-wrong { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #b91c1c !important; }
  </style>

  <script>
    // --- CONFIGURAZIONE AFFILIAZIONE ---
    const AFFILIATE_ID = "performance.logitravel.540017.560386.CRT2M0cALgB";
    const AFFILIATE_PARAM = `amc=${AFFILIATE_ID}`;
    const LOGITRAVEL_BASE = "https://www.logitravel.it";
    
    // Generatore di Link Intelligente per destinazioni
    function getDeepLink(destination, type = 'vacanze') {
      let cleanDest = destination.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
      return `${LOGITRAVEL_BASE}/${type}/${cleanDest}/?${AFFILIATE_PARAM}`;
    }

    // Aggiunge parametro affiliazione in modo sicuro a qualsiasi link
    function generateAffiliateLink(path) {
      if (!path) return `${LOGITRAVEL_BASE}/?${AFFILIATE_PARAM}`;
      
      if (path.startsWith('http')) {
        if (path.includes('logitravel.it') && !path.includes(AFFILIATE_PARAM)) {
          const separator = path.includes('?') ? '&' : '?';
          return `${path}${separator}${AFFILIATE_PARAM}`;
        }
        return path;
      }
      
      const separator = path.includes('?') ? '&' : '?';
      return `${LOGITRAVEL_BASE}${path}${separator}${AFFILIATE_PARAM}`;
    }

    function openWin(url) { 
      const target = url ? generateAffiliateLink(url) : `${LOGITRAVEL_BASE}/?${AFFILIATE_PARAM}`;
      const myWindow = window.open(target, '_blank'); 
      if (myWindow) myWindow.focus(); 
    }
  </script>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-indigo-100 selection:text-indigo-700 font-sans flex flex-col min-h-screen">

  <!-- HEADER -->  
  <header class="fixed top-0 left-0 right-0 z-50 glass-dark h-16 transition-all duration-300">
    <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
      
      <!-- Logo -->
      <div class="flex items-center gap-2 group cursor-pointer" onclick="location.reload()">
        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-1.5 rounded-lg group-hover:rotate-12 transition-transform duration-300">
          <i data-lucide="plane" class="text-white w-5 h-5"></i>
        </div>
        <span class="font-display font-bold text-xl text-white tracking-tight">Viaggi.App</span>
      </div>
      
      <!-- Desktop Nav -->
      <nav class="hidden md:flex items-center gap-8">
        <a href="https://trekk.club" target="_blank" class="text-sm font-medium text-slate-300 hover:text-white transition-colors flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-brand-trekk shadow-[0_0_8px_#4285f4]"></span> Trekk
        </a>
        <a href="https://viaggi.club" target="_blank" class="text-sm font-medium text-slate-300 hover:text-white transition-colors flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-brand-viaggi shadow-[0_0_8px_#ea4335]"></span> Viaggi
        </a>
        <a href="https://crociere.club" target="_blank" class="text-sm font-medium text-slate-300 hover:text-white transition-colors flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-brand-crociere shadow-[0_0_8px_#fbbc05]"></span> Crociere
        </a>
        <button onclick="openWin('/offerte/')" class="bg-emerald-500 hover:bg-emerald-400 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-lg shadow-emerald-500/20 transition-all hover:-translate-y-0.5 flex items-center gap-2">
          <i data-lucide="zap" class="w-4 h-4"></i> Offerte Flash
        </button>
      </nav>

      <!-- Mobile Toggle -->
      <button onclick="toggleMenu()" class="md:hidden text-white p-2 hover:bg-white/10 rounded-lg transition-colors">
        <i data-lucide="menu" class="w-6 h-6"></i>
      </button>
    </div>
  </header>

  <!-- MOBILE MENU -->
  <div id="mobileMenu" class="fixed inset-0 z-[60] pointer-events-none opacity-0 transition-opacity duration-300">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleMenu()"></div>
    <div id="mobilePanel" class="absolute right-0 top-0 bottom-0 w-80 bg-white shadow-2xl translate-x-full transition-transform duration-300 ease-out p-6 flex flex-col gap-6 pointer-events-auto">
        <div class="flex justify-between items-center border-b border-slate-100 pb-4">
            <span class="font-display font-bold text-lg text-slate-900">Menu</span>
            <button onclick="toggleMenu()" class="p-2 bg-slate-100 rounded-full text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="flex flex-col gap-4">
            <a href="https://trekk.club" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 hover:bg-blue-50 transition-colors font-medium text-slate-700"><span class="w-2 h-2 rounded-full bg-[var(--brand-trekk)]"></span> Trekk.Club</a>
            <a href="https://viaggi.club" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 hover:bg-red-50 transition-colors font-medium text-slate-700"><span class="w-2 h-2 rounded-full bg-[var(--brand-viaggi)]"></span> Viaggi.Club</a>
            <a href="https://crociere.club" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 hover:bg-yellow-50 transition-colors font-medium text-slate-700"><span class="w-2 h-2 rounded-full bg-[var(--brand-crociere)]"></span> Crociere.Club</a>
        </div>
        <div class="mt-auto">
            <button onclick="openWin('/offerte/')" class="w-full py-4 bg-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-500/20 flex items-center justify-center gap-2">
                <i data-lucide="zap" class="w-5 h-5"></i> Vedi Tutte le Offerte
            </button>
        </div>
    </div>
  </div>

  <!-- HERO SECTION -->
  <section class="relative pt-32 pb-20 px-4 min-h-[65vh] flex flex-col justify-center items-center text-center overflow-hidden">
    <!-- Background Image -->
    <div class="absolute inset-0 z-0">
      <img src="https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80" alt="Travel Background" class="w-full h-full object-cover">
      <div class="absolute inset-0 bg-gradient-to-b from-slate-900/70 via-slate-900/50 to-slate-50"></div>
    </div>

    <!-- Hero Content -->
    <div class="relative z-10 w-full max-w-3xl mx-auto">
      <span class="inline-block py-1 px-3 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-blue-100 text-xs font-bold uppercase tracking-wider mb-6 animate-fade-up">
        Il tuo Assistente di Viaggio
      </span>
      <h1 id="heroTitle" class="font-display font-extrabold text-4xl md:text-6xl text-white mb-6 leading-tight animate-fade-up [animation-delay:100ms] drop-shadow-lg">
        Il mondo ti aspetta.
      </h1>
      <p class="text-slate-200 text-lg md:text-xl max-w-xl mx-auto mb-10 animate-fade-up [animation-delay:200ms] drop-shadow-md">
        Esplora guide autentiche, offerte esclusive e pianifica il tuo viaggio perfetto.
      </p>

      <!-- ENGINE BOX -->
      <div class="glass rounded-3xl p-2 md:p-6 shadow-2xl animate-fade-up [animation-delay:300ms]">
        
        <!-- Tabs -->
        <div class="flex gap-2 mb-6 overflow-x-auto no-scrollbar p-1 justify-center md:justify-start">
          <button onclick="setMode('content')" class="tab-btn active flex-shrink-0 flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap bg-white shadow-md text-slate-900" data-target="content">
            <i data-lucide="book-open" class="w-4 h-4"></i> Guide
          </button>
          <button onclick="setMode('ai')" class="tab-btn flex-shrink-0 flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap text-slate-600 hover:bg-white/50" data-target="ai">
            <i data-lucide="sparkles" class="w-4 h-4"></i> Assistente
          </button>
          <button onclick="setMode('offers')" class="tab-btn flex-shrink-0 flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap text-slate-600 hover:bg-white/50" data-target="offers">
            <i data-lucide="tag" class="w-4 h-4"></i> Offerte
          </button>
          <button onclick="setMode('quiz')" class="tab-btn flex-shrink-0 flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap text-slate-600 hover:bg-white/50" data-target="quiz">
            <i data-lucide="brain-circuit" class="w-4 h-4"></i> Quiz
          </button>
        </div>

        <!-- SEARCH CONTAINER -->
        <div class="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-slate-100 text-left w-full">
          
          <!-- Content Form (Guide) -->
          <div id="inputs-content" class="grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-9 space-y-2">
              <label class="text-xs font-bold text-slate-400 uppercase ml-1">Cerca nel Network</label>
              <div class="relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input type="text" id="contentDestInput" class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" placeholder="Es. Trekking Dolomiti, Maldive...">
              </div>
            </div>
            <div class="md:col-span-3 flex items-end">
              <button onclick="doSearch()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/20">Esplora</button>
            </div>
          </div>

          <!-- AI Form -->
          <form id="searchForm" onsubmit="handleSearch(event)" class="hidden grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-12 space-y-2">
              <label class="text-xs font-bold text-slate-400 uppercase ml-1">Destinazione dei sogni</label>
              <div class="relative">
                <i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 text-purple-400 w-5 h-5"></i>
                <input list="destinations" id="aiDestInput" class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-purple-100 rounded-xl font-medium focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all" placeholder="Dove vuoi andare?" required>
                <datalist id="destinations"><option value="Maldive"><option value="Giappone"><option value="New York"><option value="Islanda"><option value="Parigi"></datalist>
              </div>
            </div>
            <div class="md:col-span-4 space-y-2">
              <label class="text-xs font-bold text-slate-400 uppercase ml-1">Durata</label>
              <select id="aiDays" class="w-full px-4 py-4 bg-slate-50 border border-slate-200 rounded-xl font-medium outline-none focus:border-purple-500 appearance-none">
                <option value="Weekend">Weekend</option>
                <option value="Settimana">1 Settimana</option>
                <option value="2 Settimane">2 Settimane</option>
              </select>
            </div>
            <div class="md:col-span-4 space-y-2">
              <label class="text-xs font-bold text-slate-400 uppercase ml-1">Stile</label>
              <select id="aiType" class="w-full px-4 py-4 bg-slate-50 border border-slate-200 rounded-xl font-medium outline-none focus:border-purple-500 appearance-none">
                <option value="Relax">Relax</option>
                <option value="Avventura">Avventura</option>
                <option value="Cultura">Cultura</option>
                <option value="Romantico">Romantico</option>
              </select>
            </div>
            <div class="md:col-span-4 flex items-end">
              <button type="submit" class="w-full py-4 bg-gradient-to-r from-violet-600 to-indigo-600 text-white font-bold rounded-xl hover:shadow-lg hover:shadow-indigo-500/30 hover:scale-[1.02] transition-all flex items-center justify-center gap-2"><i data-lucide="sparkles" class="w-5 h-5"></i> Crea Piano</button>
            </div>
          </form>

          <!-- Offers CTA -->
          <div id="inputs-offers" class="hidden flex flex-col items-center justify-center py-6 text-center animate-fade-up">
             <h3 class="text-lg font-bold text-slate-800 mb-2">Non sai dove andare?</h3>
             <p class="text-sm text-slate-500 mb-6 max-w-md mx-auto">Lasciati ispirare dalle promozioni esclusive del momento selezionate dai nostri partner.</p>
             <button onclick="openWin('/viaggi-offerte/')" class="px-8 py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-500/30 hover:scale-105 transition-transform flex items-center gap-2">
                <i data-lucide="compass" class="w-5 h-5"></i> Scopri le Migliori Offerte su LOGITRAVEL
             </button>
          </div>
          
          <!-- Quiz Form -->
          <div id="inputs-quiz" class="hidden grid grid-cols-1 text-center py-6 animate-fade-up">
            <h3 class="text-lg font-bold text-slate-800 mb-2">Quanto conosci il mondo? üåç</h3>
            <p class="text-sm text-slate-500 mb-6">Mettiti alla prova con il nostro quiz interattivo.</p>
            <button onclick="startQuiz()" class="mx-auto px-8 py-3 bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold rounded-full shadow-lg shadow-rose-500/30 hover:scale-105 transition-transform flex items-center gap-2"><i data-lucide="play-circle" class="w-5 h-5"></i> Inizia Quiz</button>
            <div class="mt-4">
                <button onclick="generateAIQuiz()" class="text-xs font-bold text-slate-400 hover:text-rose-500 flex items-center justify-center gap-1 mx-auto transition-colors"><i data-lucide="brain" class="w-3 h-3"></i> Genera nuove domande</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- RESULTS GRID -->
  <main class="max-w-7xl mx-auto px-4 pb-20 -mt-10 relative z-20">
    <div class="flex items-center justify-between mb-8">
        <h3 id="resultsTitle" class="font-display font-bold text-2xl text-slate-800">Ultime Guide</h3>
        <div class="h-1 flex-grow mx-4 bg-slate-100 rounded-full"></div>
    </div>
    <div id="gridContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
  </main>

  <!-- MODALS & FOOTER -->
  <div id="aiModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeAiModal()"></div>
    <div class="bg-white w-full max-w-2xl max-h-[85vh] overflow-y-auto rounded-3xl shadow-2xl relative z-10 transform transition-all scale-95 opacity-0" id="aiModalInner">
      <div class="sticky top-0 bg-white/90 backdrop-blur-md border-b border-slate-100 p-4 flex justify-between items-center z-20">
        <div class="flex items-center gap-2 text-violet-600"><i data-lucide="bot" class="w-6 h-6"></i><span class="font-bold text-lg">Il tuo Assistente</span></div>
        <button onclick="closeAiModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6 text-slate-500"></i></button>
      </div>
      <div id="aiModalBody" class="p-6 md:p-8 text-slate-600 leading-relaxed space-y-4"></div>
    </div>
  </div>

  <div id="cookie-banner" class="fixed bottom-0 left-0 right-0 md:bottom-6 md:right-6 md:left-auto md:max-w-sm z-[200] translate-y-[150%] opacity-0 transition-all duration-700 ease-out p-4 pointer-events-none">
    <div class="bg-white/95 backdrop-blur-xl border border-slate-200 shadow-2xl rounded-2xl p-6 relative overflow-hidden pointer-events-auto">
        <div class="flex items-start gap-4">
            <div class="p-3 bg-indigo-50 rounded-xl text-indigo-600"><i data-lucide="cookie" class="w-6 h-6"></i></div>
            <div>
                <h4 class="font-bold text-slate-900 text-lg mb-1">Privacy & Cookie</h4>
                <p class="text-sm text-slate-500 leading-relaxed mb-4">Utilizziamo i cookie per migliorare la tua esperienza.</p>
                <div class="flex gap-3">
                    <button onclick="acceptCookies('true')" class="flex-1 py-2 bg-slate-900 text-white text-xs font-bold rounded-lg hover:bg-slate-800">Accetta</button>
                    <button onclick="acceptCookies('false')" class="flex-1 py-2 bg-slate-100 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-200">Rifiuta</button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <footer class="bg-slate-900 text-slate-400 py-12 border-t border-slate-800 text-center mt-auto">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-center gap-2 mb-4 opacity-80"><i data-lucide="plane" class="w-6 h-6"></i><span class="font-display font-bold text-xl text-white">Viaggi.App</span></div>
      <p class="text-sm mb-8">Network Trekk.Club ‚Ä¢ Viaggi.Club ‚Ä¢ Crociere.Club</p>
    </div>
  </footer>

  <script>
    // --- APP LOGIC ---
    let currentMode = 'content'; 
    let DB = { content: [], offers: [] };
    let lastAiParams = {};
    
    // QUIZ DATA
    let QUIZ_QUESTIONS = [
        { q: "Qual √® la capitale dell'Australia?", options: ["Sydney", "Melbourne", "Canberra", "Perth"], ans: 2 },
        { q: "Dove si trova Machu Picchu?", options: ["Per√π", "Bolivia", "Messico"], ans: 0 },
        { q: "Quale citt√† √® famosa per i suoi canali?", options: ["Londra", "Venezia", "Berlino", "Parigi"], ans: 1 },
        { q: "In che stato USA si trova il Grand Canyon?", options: ["Nevada", "Arizona", "Utah", "Colorado"], ans: 1 },
        { q: "Quale piatto √® tipico di Valencia?", options: ["Pizza", "Sushi", "Paella", "Kebab"], ans: 2 }
    ];
    let currentQuizIdx = 0, quizScore = 0;

    // CATEGORIE LOGITRAVEL RICHIESTE (ESATTE)
    DB.offers = [
        { title: "Estate", desc: "Sole, mare e relax. Prenota la tua estate.", price: "Estate", icon: "sun", link: "https://www.logitravel.it/offerte/estate/" },
        { title: "Inverno & Neve", desc: "Settimane bianche, mercatini e aurore boreali.", price: "Inverno", icon: "snowflake", link: "https://www.logitravel.it/offerte/inverno/" },
        { title: "Viaggi & Offerte", desc: "Tutte le promozioni attive in un unico posto.", price: "Promo", icon: "tag", link: "https://www.logitravel.it/viaggi-offerte/" },
        { title: "Volo + Hotel", desc: "La formula smart per risparmiare sui tuoi viaggi.", price: "Smart", icon: "briefcase", link: "https://www.logitravel.it/volo-hotel/" },
        { title: "Last Minute", desc: "Parti subito! Le ultime disponibilit√† a prezzi shock.", price: "Flash", icon: "zap", link: "https://www.logitravel.it/viaggi/last-minute/" },
        { title: "Speciale Famiglie", desc: "Offerte dedicate per viaggiare con bambini.", price: "Family", icon: "users", link: "https://www.logitravel.it/offerte/speciale-famiglie/" },
        { title: "Lungo Raggio", desc: "Destinazioni esotiche e avventure lontane.", price: "Esotico", icon: "globe", link: "https://www.logitravel.it/offerte/lungo-raggio/" },
        { title: "Viaggi di Nozze", desc: "Lune di miele indimenticabili.", price: "Romantico", icon: "heart", link: "https://www.logitravel.it/offerte/viaggi-di-nozze/" },
        // Crociere Top Compagnie
        { title: "MSC Crociere", desc: "Il meglio dello stile italiano.", price: "MSC", icon: "anchor", link: "https://www.logitravel.it/crociere/compagnie-di-navigazione/msc-crociere/" },
        { title: "Costa Crociere", desc: "Il meglio dell'ospitalit√† italiana sul mare.", price: "Costa", icon: "anchor", link: "https://www.logitravel.it/crociere/compagnie-di-navigazione/costa-crociere/" },
        { title: "Royal Caribbean", desc: "Innovazione e divertimento senza limiti.", price: "Royal", icon: "anchor", link: "https://www.logitravel.it/crociere/compagnie-di-navigazione/royal-caribbean/" },
        { title: "Celebrity Cruises", desc: "Lusso moderno e gastronomia eccellente.", price: "Luxury", icon: "anchor", link: "https://www.logitravel.it/crociere/compagnie-di-navigazione/celebrity-cruises/" },
        { title: "NCL Cruises", desc: "Freestyle Cruising in libert√†.", price: "NCL", icon: "anchor", link: "https://www.logitravel.it/crociere/compagnie-di-navigazione/ncl-norwegian-cruise-line/" }
    ];

    const RSS_FEEDS = [
        { url: "https://trekk.club/feed/", color: "#4285f4", name: "Trekk" },
        { url: "https://viaggi.club/feed/", color: "#ea4335", name: "Viaggi" },
        { url: "https://crociere.club/feed/", color: "#fbbc05", name: "Crociere" }
    ];

    // INIT
    window.onload = function() {
        if (typeof lucide !== 'undefined') lucide.createIcons();
        setMode('content'); // Default start
        loadFeeds();
        
        // Cookie logic
        if (!localStorage.getItem('cookieConsent')) {
            setTimeout(() => document.getElementById('cookie-banner').classList.remove('translate-y-[150%]', 'opacity-0'), 1000);
        }
    };

    function acceptCookies(val) {
        localStorage.setItem('cookieConsent', val);
        document.getElementById('cookie-banner').classList.add('translate-y-[150%]', 'opacity-0');
    }

    function toggleMenu() {
        const menu = document.getElementById('mobileMenu');
        const panel = document.getElementById('mobilePanel');
        const isOpen = menu.style.pointerEvents === 'auto';
        
        if (isOpen) {
            menu.style.opacity = '0';
            menu.style.pointerEvents = 'none';
            panel.style.transform = 'translateX(100%)';
        } else {
            menu.style.opacity = '1';
            menu.style.pointerEvents = 'auto';
            panel.style.transform = 'translateX(0)';
        }
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'shadow-md', 'text-slate-900');
            btn.classList.add('text-slate-600', 'hover:bg-white/50');
            
            if(btn.dataset.target === mode) {
                btn.classList.remove('text-slate-600', 'hover:bg-white/50');
                btn.classList.add('bg-white', 'shadow-md', 'text-slate-900');
            }
        });

        ['searchForm','inputs-offers','inputs-quiz','inputs-content'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });
        
        const titles = { content: "Ultime Guide", ai: "Il tuo Itinerario", offers: "Categorie Offerte", quiz: "Quiz Viaggi" };
        document.getElementById('resultsTitle').innerText = titles[mode];
        const heroTitle = document.getElementById('heroTitle');

        if(mode === 'content') {
            document.getElementById('inputs-content').classList.remove('hidden');
            heroTitle.innerHTML = 'Il mondo ti aspetta.';
            renderGrid(DB.content, "");
        } else if(mode === 'ai') {
            document.getElementById('searchForm').classList.remove('hidden');
            heroTitle.innerHTML = 'Il tuo Assistente di Viaggio.';
            renderEmptyState("Compila il modulo sopra per attivare l'Assistente.");
        } else if(mode === 'offers') {
            document.getElementById('inputs-offers').classList.remove('hidden');
            heroTitle.innerHTML = 'Offerte & Promozioni.';
            renderGrid(DB.offers, "");
        } else if(mode === 'quiz') {
            document.getElementById('inputs-quiz').classList.remove('hidden');
            heroTitle.innerHTML = 'Mettiti alla Prova.';
            startQuiz();
        }
        if (window.lucide) lucide.createIcons();
    }

    function renderEmptyState(msg) {
        document.getElementById('gridContainer').innerHTML = `<div class="col-span-full py-12 text-center text-slate-400 bg-white rounded-3xl border border-dashed border-slate-200"><i data-lucide="sparkles" class="w-12 h-12 mx-auto mb-4 text-slate-200"></i><p>${msg}</p></div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function showSkeleton() {
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = Array(3).fill(0).map(() => `<div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm h-80 flex flex-col gap-4"><div class="h-40 w-full rounded-xl skeleton"></div><div class="h-4 w-full rounded-full skeleton"></div></div>`).join('');
    }

    async function loadFeeds() {
        showSkeleton();
        let allNews = [];
        const promises = RSS_FEEDS.map(f => fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(f.url)}`).then(r=>r.json()).then(d=>d.items ? d.items.map(i=>({...i, source:f.name, color:f.color})) : []).catch(()=>[]));
        const res = await Promise.all(promises);
        res.forEach(r => allNews = allNews.concat(r));
        DB.content = allNews.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));
        if(currentMode === 'content') renderGrid(DB.content, "");
    }

    function doSearch() {
        showSkeleton();
        setTimeout(() => {
            const contentInput = document.getElementById('contentDestInput');
            const query = (currentMode === 'content' && contentInput) ? contentInput.value.toLowerCase() : "";
            
            if (currentMode === 'content') {
                const results = DB.content.filter(i => i.title.toLowerCase().includes(query));
                renderGrid(results, query);
            } 
        }, 500);
    }

    function renderGrid(items, query) {
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = "";
        if (items.length === 0) { renderEmptyState(`Nessun risultato per "${query}".`); return; }
        
        items.forEach((item, idx) => {
            const delay = `style="animation-delay: ${idx * 50}ms"`;
            let html = "";
            
            if (currentMode === 'content') {
               const tempDiv = document.createElement('div');
               tempDiv.innerHTML = item.description || "";
               const text = tempDiv.textContent || "";
               html = `
               <div class="bg-white rounded-3xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-2 transition-all duration-300 flex flex-col overflow-hidden animate-fade-up" ${delay}>
                   <div class="h-2 w-full" style="background:${item.color}"></div>
                   <div class="p-6 flex flex-col flex-grow">
                       <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-md bg-slate-100 text-slate-500 w-fit mb-2">${item.source}</span>
                       <h4 class="font-display font-bold text-lg text-slate-800 mb-2 line-clamp-2">${item.title}</h4>
                       <p class="text-sm text-slate-500 line-clamp-3 mb-6 flex-grow">${text}</p>
                       <div class="grid grid-cols-2 gap-2 mt-auto">
                           <button onclick="askAISummary(${idx})" class="py-2.5 px-3 rounded-xl bg-violet-50 text-violet-600 text-xs font-bold hover:bg-violet-100 transition-colors flex items-center justify-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> Sintesi</button>
                           <a href="${item.link}" target="_blank" class="py-2.5 px-3 rounded-xl bg-slate-50 text-slate-600 text-xs font-bold hover:bg-slate-100 transition-colors text-center">Leggi</a>
                       </div>
                   </div>
               </div>`;
               
                if(idx === 2 || (idx + 1) % 5 === 0) {
                    const sponsorLink = generateAffiliateLink("https://www.logitravel.it/offerte/");
                    grid.innerHTML += `
                    <div class="col-span-1 bg-gradient-to-br from-emerald-50 to-teal-50 border border-emerald-100 rounded-3xl p-6 flex flex-col items-start hover:-translate-y-1 transition-transform animate-fade-up" style="animation-delay: ${idx*50 + 200}ms">
                        <span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-md mb-3">Consigliato</span>
                        <h4 class="font-display font-bold text-xl text-emerald-900 mb-2">Offerte del momento</h4>
                        <p class="text-sm text-emerald-700/80 mb-6">Abbiamo selezionato per te le migliori promozioni attive.</p>
                        <a href="${sponsorLink}" target="_blank" class="mt-auto w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition-colors shadow-lg text-center flex items-center justify-center gap-2">
                            Vedi offerte <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </a>
                    </div>`;
                }

            } else if (currentMode === 'offers') {
               const priceDisplay = item.price;
               const finalLink = generateAffiliateLink(item.link);
               const icon = item.icon || 'tag';

               html = `
               <div class="bg-white rounded-3xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-2 transition-all duration-300 flex flex-col overflow-hidden animate-fade-up group" ${delay}>
                   <div class="bg-slate-50 h-32 flex items-center justify-center relative overflow-hidden group-hover:bg-slate-100 transition-colors">
                       <i data-lucide="${icon}" class="text-slate-300 w-16 h-16 absolute -right-4 -bottom-4 rotate-12 group-hover:text-emerald-200 transition-colors"></i>
                       <div class="bg-white p-3 rounded-2xl shadow-sm z-10 flex flex-col items-center">
                            <span class="text-xs font-bold text-slate-400 uppercase">Categoria</span>
                            <span class="text-emerald-600 font-display font-bold text-xl">${priceDisplay}</span>
                       </div>
                   </div>
                   <div class="p-6 flex flex-col flex-grow">
                       <h4 class="font-display font-bold text-lg text-slate-800 mb-2">${item.title}</h4>
                       <p class="text-sm text-slate-500 mb-6 flex-grow">${item.desc}</p>
                       <a href="${finalLink}" target="_blank" class="w-full py-3 border-2 border-emerald-500 text-emerald-600 font-bold rounded-xl hover:bg-emerald-50 transition-colors text-center flex items-center justify-center gap-2">
                           Esplora <i data-lucide="arrow-right" class="w-4 h-4"></i>
                       </a>
                   </div>
               </div>`;
            }
            grid.innerHTML += html;
        });
        if(typeof lucide !== 'undefined') lucide.createIcons();
    }

    // --- QUIZ & AI FUNCTIONS ---
    function startQuiz() { currentQuizIdx = 0; quizScore = 0; renderQuiz(); }
    
    function renderQuiz() {
        const grid = document.getElementById('gridContainer');
        if(currentQuizIdx >= QUIZ_QUESTIONS.length) {
            grid.innerHTML = `
            <div class="col-span-full bg-white rounded-3xl p-10 text-center shadow-lg border border-rose-100 animate-fade-up">
                <div class="w-20 h-20 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="trophy" class="w-10 h-10"></i></div>
                <h3 class="font-bold text-2xl mb-2 text-slate-800">Quiz Completato!</h3>
                <p class="text-slate-500 mb-8">Punteggio: <strong class="text-rose-600">${quizScore}/${QUIZ_QUESTIONS.length}</strong></p>
                <div class="bg-gradient-to-r from-emerald-500 to-teal-500 p-6 rounded-2xl text-white mb-8 shadow-xl shadow-emerald-500/20 max-w-md mx-auto">
                    <h4 class="font-bold text-lg mb-1">Hai voglia di partire davvero?</h4>
                    <p class="text-sm opacity-90 mb-4">Abbiamo trovato offerte incredibili per te.</p>
                    <button onclick="openWin('https://www.logitravel.it/offerte/')" class="bg-white text-emerald-600 px-6 py-3 rounded-xl font-bold hover:scale-105 transition-transform shadow-md">Vedi Offerte</button>
                </div>
                <button onclick="generateAIQuiz()" class="text-sm text-slate-400 font-bold hover:text-slate-600 flex items-center justify-center gap-2 mx-auto">
                    <i data-lucide="rotate-cw" class="w-4 h-4"></i> Carica Nuove Domande
                </button>
            </div>`;
            lucide.createIcons();
            return;
        }
        const q = QUIZ_QUESTIONS[currentQuizIdx];
        grid.innerHTML = `
        <div class="col-span-full max-w-xl mx-auto bg-white rounded-3xl p-8 shadow-lg border border-rose-100 animate-fade-up">
            <div class="flex justify-between items-center mb-6">
                <span class="text-xs font-bold uppercase tracking-wider text-rose-500 bg-rose-50 px-3 py-1 rounded-full">Domanda ${currentQuizIdx+1}</span>
            </div>
            <h3 class="font-display font-bold text-xl text-slate-800 mb-6 leading-snug">${q.q}</h3>
            <div class="grid gap-3 mb-6">
                ${q.options.map((o,i)=>`<button onclick="checkAns(this,${i})" class="option-btn w-full p-4 border-2 border-slate-100 rounded-xl text-left font-bold text-slate-600 hover:border-rose-200 hover:bg-rose-50 transition-all">${o}</button>`).join('')}
            </div>
            <div class="mt-6 p-4 bg-emerald-50/80 rounded-xl border border-emerald-100 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="bg-white p-2 rounded-full shadow-sm text-emerald-500"><i data-lucide="plane" class="w-4 h-4"></i></div>
                <div class="text-xs text-emerald-800 font-medium">Sogni questa meta? <br><span class="opacity-70">Trova voli e hotel.</span></div>
              </div>
              <button onclick="openWin('https://www.logitravel.it/offerte/')" class="text-xs bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg font-bold shadow-md shadow-emerald-500/20 transition-all">Offerte</button>
            </div>
        </div>`;
        lucide.createIcons();
    }

    function checkAns(btn, i) {
        const correct = QUIZ_QUESTIONS[currentQuizIdx].ans;
        const allBtns = btn.parentElement.querySelectorAll('button');
        allBtns.forEach(b => b.disabled = true);
        
        if(i===correct) { 
            btn.classList.add('option-correct'); 
            quizScore++; 
        } else { 
            btn.classList.add('option-wrong');
            allBtns[correct].classList.add('option-correct');
        }
        setTimeout(()=>{ currentQuizIdx++; renderQuiz(); }, 1500);
    }

    async function generateAIQuiz() {
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = `<div class="col-span-full text-center py-12"><div class="w-12 h-12 border-4 border-rose-200 border-t-rose-600 rounded-full animate-spin mx-auto mb-4"></div><p class="text-slate-500">Generazione nuove domande in corso...</p></div>`;
        const prompt = `Genera 5 nuove domande quiz di viaggio a risposta multipla su questi temi: vacanze estive, vacanze invernali, viaggi last minute, volo+hotel. Formato JSON array ESATTO: [{"q": "Domanda", "options": ["A","B","C","D"], "ans": 0}]. Nient'altro.`;
        try {
            const txt = await callGemini(prompt);
            const cleanJson = txt.replace(/```json/g, '').replace(/```/g, '').trim();
            const newQs = JSON.parse(cleanJson);
            if(Array.isArray(newQs) && newQs.length > 0) {
                QUIZ_QUESTIONS = newQs; 
                startQuiz();
            } else throw new Error("Formato non valido");
        } catch(e) {
            console.error(e);
            alert("Riprova, stiamo ricaricando le domande.");
            startQuiz(); 
        }
    }

    async function callGemini(p) {
        try {
            const r = await fetch('/api/ask-ai', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({prompt:p}) });
            if(!r.ok) throw new Error();
            const d = await r.json(); return d.result;
        } catch(e) {
            if(p.includes("JSON")) return `[
                {"q": "Quale destinazione √® famosa per le vacanze estive low cost?", "options": ["Maldive", "Albania", "New York", "Islanda"], "ans": 1},
                {"q": "Dove si trovano le migliori piste da sci per l'inverno?", "options": ["Dolomiti", "Sahara", "Roma", "Sicilia"], "ans": 0},
                {"q": "Cosa significa offerta 'Last Minute'?", "options": ["Prenotare 1 anno prima", "Prenotare all'ultimo", "Viaggiare gratis", "Solo per gruppi"], "ans": 1},
                {"q": "Qual √® il vantaggio del pacchetto Volo+Hotel?", "options": ["Costa di pi√π", "Risparmi e comodit√†", "Non include hotel", "Solo per VIP"], "ans": 1},
                {"q": "Quale di queste √® una famosa compagnia di crociere?", "options": ["Ryanair", "MSC", "Trenitalia", "Flixbus"], "ans": 1}
            ]`;
            return `## Itinerario Demo (Server Offline)\n\n*Nota: Questo √® un esempio perch√© il backend non √® raggiungibile.*\n\n### Giorno 1: Arrivo\n* Relax in centro.\n### Giorno 2: Visite\n* Tour della citt√†.`;
        }
    }
    
    function handleSearch(e) { e.preventDefault(); generateItinerary(); }
    async function generateItinerary() {
        const dest = document.getElementById('aiDestInput').value;
        if(!dest) return;
        document.getElementById('gridContainer').innerHTML = `<div class="col-span-full text-center py-12"><div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-4"></div><p>Stiamo scrivendo...</p></div>`;
        const txt = await callGemini(`Itinerario per ${dest} in italiano.`);
        document.getElementById('gridContainer').innerHTML = `<div class="col-span-full bg-white rounded-3xl p-8 shadow-lg border border-purple-100 prose max-w-none">${marked.parse(txt)}<div class="mt-8 text-center"><button onclick="openWin(getDeepLink('${dest}'))" class="px-6 py-3 bg-emerald-500 text-white font-bold rounded-xl shadow-lg">Vedi Prezzi per ${dest}</button></div></div>`;
    }
    
    async function askAISummary(i) {
        const item = DB.content[i];
        const m = document.getElementById('aiModal');
        m.classList.remove('hidden'); m.classList.add('flex');
        setTimeout(()=>document.getElementById('aiModalInner').classList.remove('scale-95','opacity-0'),10);
        document.getElementById('aiModalBody').innerHTML = `<div class="text-center"><div class="w-8 h-8 border-4 border-slate-200 border-t-purple-600 rounded-full animate-spin mx-auto"></div></div>`;
        
        // Improved prompt for better synthesis
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = item.description || '';
        const cleanDesc = tempDiv.textContent.trim().substring(0, 1500); 
        const prompt = `Fai una sintesi accattivante in italiano di questo articolo di viaggio basandoti sul titolo: "${item.title}" e sul seguente contenuto: "${cleanDesc}". Usa emoji e rendilo interessante per un viaggiatore.`;

        const txt = await callGemini(prompt);
        
        // Add the button
        const affiliateLink = generateAffiliateLink(item.link); 
        
        const htmlContent = `
            <div class="prose prose-sm max-w-none text-slate-600">
                ${marked.parse(txt)}
            </div>
            <div class="mt-6 text-center">
                <a href="${affiliateLink}" target="_blank" 
                   class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold rounded-xl shadow-lg hover:scale-105 transition-transform">
                   üìñ Leggi l'articolo completo
                </a>
            </div>
        `;
        
        document.getElementById('aiModalBody').innerHTML = htmlContent;
    }
    function closeAiModal() {
        document.getElementById('aiModalInner').classList.add('scale-95','opacity-0');
        setTimeout(()=>{ document.getElementById('aiModal').classList.add('hidden'); document.getElementById('aiModal').classList.remove('flex'); },300);
    }
  </script>
</body>
</html>
