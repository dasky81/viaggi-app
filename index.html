<!DOCTYPE html>
<html lang="it" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Viaggi.App ‚Ä¢ AI Travel Assistant</title>
  <meta name="description" content="Il tuo agente di viaggio virtuale. Cerca, pianifica e parti con l'IA.">

  <!-- FONTS & ICONS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <!-- MARKDOWN PARSER -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- TAILWIND CSS (Modern Styling) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Plus Jakarta Sans"', 'sans-serif'],
            display: ['"Outfit"', 'sans-serif'],
          },
          colors: {
            primary: '#0f172a',
            accent: '#3b82f6',
            brand: {
              trekk: '#4285f4',
              viaggi: '#ea4335',
              crociere: '#fbbc05',
              ai: '#8b5cf6',
              sponsor: '#10b981'
            }
          },
          animation: {
            'fade-up': 'fadeUp 0.6s ease-out forwards',
            'shimmer': 'shimmer 2s linear infinite',
          },
          keyframes: {
            fadeUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            shimmer: {
              '0%': { backgroundPosition: '-1000px 0' },
              '100%': { backgroundPosition: '1000px 0' }
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Glassmorphism & Utilities */
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .glass-dark {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .text-gradient {
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-image: linear-gradient(to right, #3b82f6, #8b5cf6);
    }
    
    /* Hide scrollbar for tabs */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Skeleton Loading Animation */
    .skeleton {
      background: #f6f7f8;
      background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
      background-repeat: no-repeat;
      background-size: 1000px 100%;
      animation: shimmer 1.5s infinite linear forwards;
    }
  </style>

  <script>
    function openWin() { 
        const myWindow = window.open('https://img.affiliate.logitravel.com/uploaded/docs/52d6a5f402b18-LinkBuilderIT.html','_blank','width=700,height=1000,scrollbars=yes'); 
        if(myWindow) myWindow.focus(); 
    }
  </script>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-indigo-100 selection:text-indigo-700">

  <!-- HEADER -->
  <header class="fixed top-0 left-0 right-0 z-50 glass-dark h-16 transition-all duration-300">
    <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
      
      <!-- Logo -->
      <div class="flex items-center gap-2 group cursor-pointer">
        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-1.5 rounded-lg group-hover:rotate-12 transition-transform duration-300">
          <i data-lucide="plane" class="text-white w-5 h-5"></i>
        </div>
        <span class="font-display font-bold text-xl text-white tracking-tight">Viaggi.App</span>
      </div>

      <!-- Desktop Nav -->
      <nav class="hidden md:flex items-center gap-6">
        <a href="https://trekk.club" target="_blank" class="text-sm font-medium text-slate-300 hover:text-white transition-colors flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-[var(--brand-trekk)] shadow-[0_0_8px_var(--brand-trekk)]"></span> Trekk
        </a>
        <a href="https://viaggi.club" target="_blank" class="text-sm font-medium text-slate-300 hover:text-white transition-colors flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-[var(--brand-viaggi)] shadow-[0_0_8px_var(--brand-viaggi)]"></span> Viaggi
        </a>
        <a href="https://crociere.club" target="_blank" class="text-sm font-medium text-slate-300 hover:text-white transition-colors flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-[var(--brand-crociere)] shadow-[0_0_8px_var(--brand-crociere)]"></span> Crociere
        </a>
        <button onclick="openWin()" class="bg-emerald-500 hover:bg-emerald-400 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-emerald-500/20 transition-all hover:-translate-y-0.5">
          Offerte Flash
        </button>
      </nav>

      <!-- Mobile Menu Button -->
      <button onclick="toggleMenu()" class="md:hidden text-white p-2 hover:bg-white/10 rounded-lg">
        <i data-lucide="menu" class="w-6 h-6"></i>
      </button>
    </div>
  </header>

  <!-- MOBILE MENU -->
  <div id="mobile-menu" class="fixed inset-0 z-[60] pointer-events-none opacity-0 transition-opacity duration-300">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleMenu()"></div>
    <!-- Panel -->
    <div id="mobile-panel" class="absolute right-0 top-0 bottom-0 w-80 bg-white shadow-2xl translate-x-full transition-transform duration-300 ease-out p-6 flex flex-col gap-6 pointer-events-auto">
      <div class="flex justify-between items-center border-b border-slate-100 pb-4">
        <span class="font-display font-bold text-lg text-slate-900">Menu</span>
        <button onclick="toggleMenu()" class="p-2 bg-slate-100 rounded-full text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="flex flex-col gap-3">
        <a href="https://trekk.club" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 hover:bg-blue-50 transition-colors font-medium text-slate-700">
          <span class="w-2 h-2 rounded-full bg-[var(--brand-trekk)]"></span> Trekk.Club
        </a>
        <a href="https://viaggi.club" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 hover:bg-red-50 transition-colors font-medium text-slate-700">
          <span class="w-2 h-2 rounded-full bg-[var(--brand-viaggi)]"></span> Viaggi.Club
        </a>
        <a href="https://crociere.club" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 hover:bg-yellow-50 transition-colors font-medium text-slate-700">
          <span class="w-2 h-2 rounded-full bg-[var(--brand-crociere)]"></span> Crociere.Club
        </a>
      </div>
      <div class="mt-auto">
        <button onclick="openWin()" class="w-full py-4 bg-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-500/20">Vedi Tutte le Offerte</button>
      </div>
    </div>
  </div>

  <!-- HERO SECTION -->
  <section class="relative pt-32 pb-32 px-4 overflow-hidden">
    <!-- Background Image with Overlay -->
    <div class="absolute inset-0 z-0">
      <img src="https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80" alt="Travel Background" class="w-full h-full object-cover">
      <div class="absolute inset-0 bg-gradient-to-b from-slate-900/80 via-slate-900/60 to-slate-50"></div>
    </div>

    <!-- Content -->
    <div class="relative z-10 max-w-4xl mx-auto text-center">
      <span class="inline-block py-1 px-3 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-blue-200 text-xs font-bold uppercase tracking-wider mb-6 animate-fade-up">
        AI Travel Planner 2025
      </span>
      <h1 id="heroTitle" class="font-display font-extrabold text-4xl md:text-6xl text-white mb-6 leading-tight animate-fade-up [animation-delay:100ms]">
        Esplora il mondo <br /> <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">senza confini.</span>
      </h1>
      <p class="text-slate-300 text-lg md:text-xl max-w-2xl mx-auto mb-10 animate-fade-up [animation-delay:200ms]">
        Dalle guide autentiche all'intelligenza artificiale: crea il tuo itinerario perfetto in pochi secondi.
      </p>

      <!-- ENGINE BOX -->
      <div class="glass rounded-3xl p-2 md:p-6 shadow-2xl animate-fade-up [animation-delay:300ms] border-white/40 bg-white/80 backdrop-blur-xl">
        
        <!-- Tabs -->
        <div class="flex gap-2 mb-6 overflow-x-auto no-scrollbar p-1">
          <button onclick="setMode('content')" class="tab-btn active flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap" data-target="content">
            <i data-lucide="book-open" class="w-4 h-4"></i> Guide
          </button>
          <button onclick="setMode('ai')" class="tab-btn flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap" data-target="ai">
            <i data-lucide="sparkles" class="w-4 h-4"></i> AI Agent
          </button>
          <button onclick="setMode('offers')" class="tab-btn flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap" data-target="offers">
            <i data-lucide="tag" class="w-4 h-4"></i> Offerte
          </button>
        </div>

        <!-- SEARCH FORMS -->
        <div class="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-slate-100 text-left">
          
          <!-- Content Form -->
          <div id="inputs-content" class="grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-9 space-y-2">
              <label class="text-xs font-bold text-slate-400 uppercase ml-1">Cerca nel Network</label>
              <div class="relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input type="text" id="contentDestInput" class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" placeholder="Es. Trekking Dolomiti, Maldive...">
              </div>
            </div>
            <div class="md:col-span-3 flex items-end">
              <button onclick="doSearch()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/20">
                Esplora
              </button>
            </div>
          </div>

          <!-- AI Form -->
          <form id="searchForm" onsubmit="handleSearch(event)" class="hidden grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-12 space-y-2">
              <label class="text-xs font-bold text-slate-400 uppercase ml-1">Destinazione dei sogni</label>
              <div class="relative">
                <i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 text-purple-400 w-5 h-5"></i>
                <input list="destinations" id="aiDestInput" class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-purple-100 rounded-xl font-medium focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all" placeholder="Dove vuoi andare?" required>
                <datalist id="destinations">
                    <option value="Maldive"><option value="Giappone"><option value="New York"><option value="Islanda"><option value="Parigi">
                </datalist>
              </div>
            </div>
            <div class="md:col-span-4 space-y-2">
              <label class="text-xs font-bold text-slate-400 uppercase ml-1">Durata</label>
              <select id="aiDays" class="w-full px-4 py-4 bg-slate-50 border border-slate-200 rounded-xl font-medium outline-none focus:border-purple-500 appearance-none">
                <option value="Weekend">Weekend</option>
                <option value="Settimana">1 Settimana</option>
                <option value="10 Giorni">10 Giorni</option>
                <option value="2 Settimane">2 Settimane</option>
              </select>
            </div>
            <div class="md:col-span-4 space-y-2">
              <label class="text-xs font-bold text-slate-400 uppercase ml-1">Stile</label>
              <select id="aiType" class="w-full px-4 py-4 bg-slate-50 border border-slate-200 rounded-xl font-medium outline-none focus:border-purple-500 appearance-none">
                <option value="Relax">üßò Relax</option>
                <option value="Avventura">üéí Avventura</option>
                <option value="Cultura">üèõ Cultura</option>
                <option value="Romantico">üíë Romantico</option>
              </select>
            </div>
            <div class="md:col-span-4 flex items-end">
              <button type="submit" class="w-full py-4 bg-gradient-to-r from-violet-600 to-indigo-600 text-white font-bold rounded-xl hover:shadow-lg hover:shadow-indigo-500/30 hover:scale-[1.02] transition-all flex items-center justify-center gap-2">
                <i data-lucide="sparkles" class="w-5 h-5"></i> Genera Piano
              </button>
            </div>
          </form>

          <!-- Offers Form -->
          <div id="inputs-offers" class="hidden grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-9 space-y-2">
              <label class="text-xs font-bold text-slate-400 uppercase ml-1">Cerca Offerta</label>
              <div class="relative">
                <i data-lucide="tag" class="absolute left-4 top-1/2 -translate-y-1/2 text-emerald-500 w-5 h-5"></i>
                <input type="text" id="offerDestInput" class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-emerald-100 rounded-xl font-medium focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all" placeholder="Es. Sharm, Crociere...">
              </div>
            </div>
            <div class="md:col-span-3 flex items-end">
              <button onclick="doSearch()" class="w-full py-4 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-500 transition-all shadow-lg shadow-emerald-600/20">
                Trova Prezzi
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- RESULTS GRID -->
  <main class="max-w-7xl mx-auto px-4 pb-20 -mt-10 relative z-20">
    <div class="flex items-center justify-between mb-8">
        <h3 id="resultsTitle" class="font-display font-bold text-2xl text-slate-800">Ultime Guide</h3>
        <div class="h-1 flex-grow mx-4 bg-slate-100 rounded-full"></div>
    </div>

    <!-- Grid Container -->
    <div id="gridContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      <!-- Content injected via JS -->
    </div>
  </main>

  <!-- AI MODAL -->
  <div id="aiModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeAiModal()"></div>
    <div class="bg-white w-full max-w-2xl max-h-[85vh] overflow-y-auto rounded-3xl shadow-2xl relative z-10 transform transition-all scale-95 opacity-0" id="aiModalInner">
      <div class="sticky top-0 bg-white/90 backdrop-blur-md border-b border-slate-100 p-4 flex justify-between items-center z-20">
        <div class="flex items-center gap-2 text-violet-600">
            <i data-lucide="bot" class="w-6 h-6"></i>
            <span class="font-bold text-lg">AI Assistant</span>
        </div>
        <button onclick="closeAiModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6 text-slate-500"></i></button>
      </div>
      <div id="aiModalBody" class="p-6 md:p-8 text-slate-600 leading-relaxed space-y-4">
        <!-- AI Content -->
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="bg-slate-900 text-slate-400 py-12 border-t border-slate-800">
    <div class="max-w-7xl mx-auto px-4 text-center">
      <div class="flex items-center justify-center gap-2 mb-4 opacity-80">
        <i data-lucide="plane" class="w-6 h-6"></i>
        <span class="font-display font-bold text-xl text-white">Viaggi.App</span>
      </div>
      <p class="text-sm mb-8">Il tuo compagno di viaggio intelligente.</p>
      <div class="flex justify-center gap-6 text-sm font-medium">
        <a href="#" class="hover:text-white transition-colors">Privacy</a>
        <a href="#" class="hover:text-white transition-colors">Termini</a>
        <a href="#" class="hover:text-white transition-colors">Contatti</a>
      </div>
      <div class="mt-8 text-xs text-slate-600">
        &copy; 2025 Network Trekk.Club ‚Ä¢ Viaggi.Club ‚Ä¢ Crociere.Club
      </div>
    </div>
  </footer>

  <!-- LOGIC SCRIPT -->
  <script>
    // --- UI LOGIC ---
    lucide.createIcons();

    function toggleMenu() {
        const menu = document.getElementById('mobile-menu');
        const panel = document.getElementById('mobile-panel');
        
        if (menu.style.pointerEvents === 'auto') {
            // Close
            menu.style.opacity = '0';
            panel.style.transform = 'translateX(100%)';
            menu.style.pointerEvents = 'none';
        } else {
            // Open
            menu.style.opacity = '1';
            panel.style.transform = 'translateX(0)';
            menu.style.pointerEvents = 'auto';
        }
    }

    function setMode(mode) {
        currentMode = mode;
        // Update Tabs UI
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-slate-900', 'text-white', 'shadow-md');
            btn.classList.add('text-slate-500', 'hover:bg-slate-200');
            
            if(btn.dataset.target === mode) {
                btn.classList.remove('text-slate-500', 'hover:bg-slate-200');
                if(mode === 'ai') btn.classList.add('bg-violet-600', 'text-white', 'shadow-md', 'shadow-violet-200');
                else if(mode === 'offers') btn.classList.add('bg-emerald-600', 'text-white', 'shadow-md', 'shadow-emerald-200');
                else btn.classList.add('bg-slate-900', 'text-white', 'shadow-md');
            }
        });

        // Hide all forms
        document.getElementById('inputs-content').classList.add('hidden');
        document.getElementById('searchForm').classList.add('hidden');
        document.getElementById('inputs-offers').classList.add('hidden');

        // Show active form & Update Text
        const title = document.getElementById('resultsTitle');
        const heroTitle = document.getElementById('heroTitle');

        if(mode === 'ai') {
            document.getElementById('searchForm').classList.remove('hidden');
            heroTitle.innerHTML = 'Il tuo <span class="text-transparent bg-clip-text bg-gradient-to-r from-violet-500 to-fuchsia-500">Assistente Personale</span>';
            title.innerText = 'Il tuo Itinerario';
            renderEmptyState("Compila il modulo sopra per attivare l'Intelligenza Artificiale.");
        } else if(mode === 'content') {
            document.getElementById('inputs-content').classList.remove('hidden');
            heroTitle.innerHTML = 'Esplora il mondo <br /> <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">senza confini.</span>';
            title.innerText = 'Ultime Guide dal Network';
            renderGrid(DB.content, "");
        } else {
            document.getElementById('inputs-offers').classList.remove('hidden');
            heroTitle.innerHTML = 'Offerte <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-teal-400">Esclusive</span>';
            title.innerText = 'Migliori Prezzi del Momento';
            renderGrid(DB.offers, "");
        }
    }

    function renderEmptyState(msg) {
        document.getElementById('gridContainer').innerHTML = `
            <div class="col-span-full py-12 text-center text-slate-400 bg-white rounded-3xl border border-dashed border-slate-200">
                <i data-lucide="sparkles" class="w-12 h-12 mx-auto mb-4 text-slate-200"></i>
                <p>${msg}</p>
            </div>
        `;
        lucide.createIcons();
    }

    function showSkeleton() {
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = Array(3).fill(0).map(() => `
            <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm h-80 flex flex-col gap-4">
                <div class="h-40 w-full rounded-xl skeleton"></div>
                <div class="h-6 w-3/4 rounded-full skeleton"></div>
                <div class="h-4 w-full rounded-full skeleton"></div>
                <div class="h-4 w-1/2 rounded-full skeleton"></div>
            </div>
        `).join('');
    }

    // --- DATA & API LOGIC ---
    let currentMode = 'content';
    let DB = { content: [], offers: [] };
    let lastAiParams = {};
    let currentItems = [];

    // DATA
    DB.offers = [
        { title: "Marsa Alam Life Resort", provider: "Logitravel", price: 234, desc: "Volo + 7 notti, All Inclusive. Partenza Gennaio.", link: "https://www.logitravel.it/viaggi/marsa-alam/" },
        { title: "Londra & Harry Potter", provider: "Logitravel", price: 363, desc: "3 giorni / 2 notti con ingresso Studios incluso.", link: "https://www.logitravel.it/viaggi/londra/" },
        { title: "Budapest City Break", provider: "Logitravel", price: 117, desc: "Volo + Hotel centrale, 3 giorni.", link: "https://www.logitravel.it/viaggi/budapest/" },
        { title: "Crociera MSC Mediterraneo", provider: "MSC", price: 499, desc: "7 notti: Italia, Francia, Spagna. Pensione completa.", link: "https://www.msccrociere.it" },
        { title: "Sharm El Sheikh 5*", provider: "Logitravel", price: 352, desc: "Coral Hills Resort, All Inclusive, Sconti Black Week.", link: "https://www.logitravel.it/viaggi/sharm-el-sheikh/" },
        { title: "New York Times Square", provider: "Logitravel", price: 892, desc: "Volo + 5 notti in hotel centrale.", link: "https://www.logitravel.it/viaggi/new-york/" }
    ];

    const RSS_FEEDS = [
        { url: "https://trekk.club/feed/", color: "#4285f4", name: "Trekk" },
        { url: "https://viaggi.club/feed/", color: "#ea4335", name: "Viaggi" },
        { url: "https://crociere.club/feed/", color: "#fbbc05", name: "Crociere" }
    ];
    const API_PROXY = "https://api.rss2json.com/v1/api.json?rss_url=";

    async function loadFeeds() {
        showSkeleton();
        let allNews = [];
        const promises = RSS_FEEDS.map(f => fetch(API_PROXY + encodeURIComponent(f.url))
            .then(r=>r.json())
            .then(d=>d.items ? d.items.map(i=>({...i, source:f.name, color:f.color})) : [])
            .catch(()=>[])
        );
        const res = await Promise.all(promises);
        res.forEach(r => allNews = allNews.concat(r));
        DB.content = allNews.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));
        
        if(currentMode === 'content') renderGrid(DB.content, "");
    }

    function doSearch() {
        showSkeleton();
        setTimeout(() => {
            let results = [];
            let query = "";
            if(currentMode === 'content') {
                query = document.getElementById('contentDestInput').value.toLowerCase();
                results = DB.content.filter(i => i.title.toLowerCase().includes(query));
            } else {
                query = document.getElementById('offerDestInput').value.toLowerCase();
                results = DB.offers.filter(i => i.title.toLowerCase().includes(query));
            }
            renderGrid(results, query);
        }, 600);
    }

    function handleSearch(e) {
        e.preventDefault();
        if(currentMode === 'ai') generateItinerary();
    }

    function renderGrid(items, query) {
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = "";
        
        let workingItems = items;
        if (workingItems.length === 0) {
            renderEmptyState(`Nessun risultato trovato per "${query}".`);
            workingItems = currentMode === 'content' ? DB.content.slice(0,6) : DB.offers;
        }

        currentItems = workingItems;

        workingItems.forEach((item, idx) => {
            let html = "";
            const delay = `style="animation-delay: ${idx * 100}ms"`;
            
            // --- SPONSOR CARD ---
            if(idx === 2) {
                grid.innerHTML += `
                <div class="col-span-1 bg-emerald-50 border border-emerald-100 rounded-3xl p-6 flex flex-col items-start hover:-translate-y-1 transition-transform animate-fade-up" ${delay}>
                    <span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-md mb-3">Sponsor</span>
                    <h4 class="font-display font-bold text-xl text-emerald-900 mb-2">Offerte Logitravel</h4>
                    <p class="text-sm text-emerald-700/80 mb-6">Pacchetti vacanze e crociere ai migliori prezzi.</p>
                    <button onclick="openWin()" class="mt-auto w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition-colors shadow-lg shadow-emerald-600/10">Vedi Promozioni</button>
                </div>`;
            }

            // --- STANDARD CARD ---
            if(currentMode === 'content') {
                const tempDiv = document.createElement('div'); 
                tempDiv.innerHTML = item.description || "";
                const text = tempDiv.textContent || tempDiv.innerText || "";
                item._plainText = text;

                html = `
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-2 transition-all duration-300 flex flex-col overflow-hidden group animate-fade-up" ${delay}>
                    <div class="h-2 w-full" style="background:${item.color}"></div>
                    <div class="p-6 flex flex-col flex-grow">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-md bg-slate-100 text-slate-500">${item.source}</span>
                        </div>
                        <h4 class="font-display font-bold text-lg text-slate-800 mb-3 group-hover:text-blue-600 transition-colors line-clamp-2">${item.title}</h4>
                        <p class="text-sm text-slate-500 line-clamp-3 mb-6 flex-grow">${text}</p>
                        
                        <div class="grid grid-cols-2 gap-2 mt-auto">
                            <button onclick="askAISummary(${idx})" class="py-2.5 px-3 rounded-xl bg-violet-50 text-violet-600 text-xs font-bold hover:bg-violet-100 transition-colors flex items-center justify-center gap-1">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> AI Summary
                            </button>
                            <a href="${item.link}" target="_blank" class="py-2.5 px-3 rounded-xl bg-slate-50 text-slate-600 text-xs font-bold hover:bg-slate-100 transition-colors text-center flex items-center justify-center gap-1">
                                Leggi <i data-lucide="arrow-right" class="w-3 h-3"></i>
                            </a>
                        </div>
                    </div>
                </div>`;
            } else {
                // OFFER CARD
                html = `
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-2 transition-all duration-300 flex flex-col overflow-hidden animate-fade-up" ${delay}>
                   <div class="bg-slate-900 h-32 flex items-center justify-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/20 to-blue-500/20"></div>
                        <i data-lucide="plane" class="text-white/20 w-16 h-16 absolute -right-4 -bottom-4 rotate-12"></i>
                        <h3 class="text-white font-display font-bold text-2xl relative z-10">‚Ç¨ ${item.price}</h3>
                   </div>
                   <div class="p-6 flex flex-col flex-grow">
                        <span class="text-xs font-bold text-slate-400 uppercase mb-1">${item.provider}</span>
                        <h4 class="font-display font-bold text-lg text-slate-800 mb-2">${item.title}</h4>
                        <p class="text-sm text-slate-500 mb-4 flex-grow">${item.desc}</p>
                        <a href="${item.link}" target="_blank" class="w-full py-3 border-2 border-emerald-500 text-emerald-600 font-bold rounded-xl hover:bg-emerald-50 transition-colors text-center">Vedi Offerta</a>
                   </div>
                </div>`;
            }
            grid.innerHTML += html;
        });
        lucide.createIcons();
    }

    // --- AI LOGIC (BACKEND CONNECTED) ---
    async function callGemini(prompt) {
        // La chiamata sicura a Vercel
        try {
            const res = await fetch('/api/ask-ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });
            const data = await res.json();
            if (!res.ok) return "Errore tecnico. Riprova pi√π tardi.";
            return data.result; 
        } catch (e) {
            return "Errore di connessione.";
        }
    }

    async function generateItinerary() {
        const dest = document.getElementById('aiDestInput').value;
        const days = document.getElementById('aiDays').value;
        const type = document.getElementById('aiType').value;
        if(!dest) return;

        lastAiParams = { dest, days, type };
        
        // Loader UI
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = `
            <div class="col-span-full bg-white rounded-3xl p-12 text-center shadow-lg border border-purple-100">
                <div class="w-16 h-16 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin mx-auto mb-6"></div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">L'AI sta pianificando il viaggio a ${dest}...</h3>
                <p class="text-slate-500">Analisi di voli, hotel ed esperienze in corso.</p>
            </div>
        `;

        const prompt = `Agisci come travel planner esperto. Crea itinerario per ${dest}, ${days}, stile ${type}. 
        Formatta in Markdown. Usa Titoli H2, liste puntate ed emoji.`;
        
        const text = await callGemini(prompt);
        const html = typeof marked !== 'undefined' ? marked.parse(text) : text;

        grid.innerHTML = `
        <div class="col-span-full bg-white rounded-3xl border-2 border-purple-500 p-6 md:p-10 shadow-2xl animate-fade-up relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="sparkles" class="w-32 h-32 text-purple-600"></i></div>
            
            <div class="prose prose-slate prose-lg max-w-none mb-10">
                ${html}
            </div>

            <!-- AI Action Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-8 border-t border-slate-100">
                ${renderAiBtn('bag', 'Valigia', 'backpack')}
                ${renderAiBtn('food', 'Cibo Tipico', 'utensils')}
                ${renderAiBtn('lang', 'Frasi Utili', 'languages')}
                ${renderAiBtn('budget', 'Budget', 'wallet')}
                ${renderAiBtn('gems', 'Gemme Nascoste', 'gem')}
                ${renderAiBtn('safety', 'Sicurezza', 'shield-check')}
                ${renderAiBtn('photo', 'Spot Foto', 'camera')}
                ${renderAiBtn('souvenir', 'Souvenir', 'gift')}
            </div>

            <!-- CTA Logitravel -->
            <div class="mt-10 bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl p-6 text-center text-white relative overflow-hidden">
                 <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="text-left">
                        <h4 class="font-bold text-lg">Ti piace questo itinerario?</h4>
                        <p class="text-slate-400 text-sm">Trova subito voli e hotel per ${dest}</p>
                    </div>
                    <button onclick="openWin()" class="px-6 py-3 bg-emerald-500 hover:bg-emerald-400 text-white font-bold rounded-xl transition-all shadow-lg shadow-emerald-500/20 whitespace-nowrap">
                        Vedi Prezzi Reali
                    </button>
                 </div>
            </div>
        </div>`;
        lucide.createIcons();
    }

    function renderAiBtn(task, label, icon) {
        return `
        <button onclick="aiTask('${task}')" class="flex flex-col items-center gap-2 p-4 rounded-xl border border-slate-200 hover:border-purple-400 hover:bg-purple-50 transition-all group">
            <i data-lucide="${icon}" class="w-6 h-6 text-slate-400 group-hover:text-purple-600 transition-colors"></i>
            <span class="text-xs font-bold text-slate-600 group-hover:text-purple-700">${label}</span>
        </button>`;
    }

    async function aiTask(task) {
        const { dest } = lastAiParams;
        openAiModal();
        const body = document.getElementById('aiModalBody');
        body.innerHTML = `<div class="text-center py-10"><div class="w-10 h-10 border-4 border-slate-100 border-t-purple-600 rounded-full animate-spin mx-auto mb-4"></div><p>L'AI sta scrivendo...</p></div>`;
        
        let prompt = "";
        if(task==='bag') prompt = `Lista valigia per ${dest}. Bullet points.`;
        if(task==='food') prompt = `3 Piatti tipici di ${dest}. Descrizione breve.`;
        if(task==='lang') prompt = `5 Frasi utili in lingua locale per ${dest}.`;
        if(task==='budget') prompt = `Stima budget giornaliero medio per ${dest} (Cibo, Trasporti).`;
        if(task==='gems') prompt = `2 Luoghi poco turistici a ${dest}.`;
        if(task==='safety') prompt = `Consigli sicurezza e truffe da evitare a ${dest}.`;
        if(task==='photo') prompt = `Migliori spot fotografici a ${dest}.`;
        if(task==='souvenir') prompt = `Cosa comprare di autentico a ${dest}.`;

        const text = await callGemini(prompt);
        body.innerHTML = typeof marked !== 'undefined' ? marked.parse(text) : text;
    }

    async function askAISummary(idx) {
        const item = currentItems[idx];
        openAiModal();
        const body = document.getElementById('aiModalBody');
        body.innerHTML = `<div class="text-center py-10"><div class="w-10 h-10 border-4 border-slate-100 border-t-purple-600 rounded-full animate-spin mx-auto mb-4"></div><p>Analisi articolo...</p></div>`;

        const ctx = (item._plainText || item.description || "").toString();
        const prompt = `Analizza: "${item.title}". Contesto: "${ctx.substring(0,300)}". Dammi 3 motivi bullet point per visitare.`;
        
        const text = await callGemini(prompt);
        let html = typeof marked !== 'undefined' ? marked.parse(text) : text;
        html += `<div class="mt-6 pt-6 border-t border-slate-100 text-center"><button onclick="openWin()" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl">Vedi Offerte Correlate</button></div>`;
        body.innerHTML = html;
    }

    function openAiModal() {
        const modal = document.getElementById('aiModal');
        const inner = document.getElementById('aiModalInner');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        // Small delay for animation
        setTimeout(() => {
            inner.classList.remove('scale-95', 'opacity-0');
            inner.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeAiModal() {
        const modal = document.getElementById('aiModal');
        const inner = document.getElementById('aiModalInner');
        inner.classList.remove('scale-100', 'opacity-100');
        inner.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    // Init
    setMode('content');
    loadFeeds();
  </script>
</body>
</html>
